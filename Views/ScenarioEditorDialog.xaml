<Window x:Class="AutoRegressionVM.Views.ScenarioEditorDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="시나리오 편집" Height="700" Width="900"
        WindowStartupLocation="CenterOwner"
        MinWidth="800" MinHeight="600">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 시나리오 기본 정보 및 이벤트 -->
        <GroupBox Grid.Row="0" Header="시나리오 설정" Margin="0,0,0,10">
            <TabControl Margin="5">
                <!-- 기본 정보 탭 -->
                <TabItem Header="기본 정보">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="80"/>
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Row="0" Text="이름:" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="1" x:Name="txtName" Margin="0,0,10,5"/>
                        <TextBlock Grid.Row="0" Grid.Column="2" Text="병렬 VM:" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="3" x:Name="txtMaxParallel" Text="1" Margin="0,0,0,5"/>

                        <TextBlock Grid.Row="1" Text="설명:" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="3" x:Name="txtDescription" Margin="0,0,0,5"/>

                        <CheckBox Grid.Row="2" Grid.Column="1" x:Name="chkContinueOnFailure" Content="실패 시 계속 진행" IsChecked="True"/>
                    </Grid>
                </TabItem>

                <!-- 테스트 전 이벤트 탭 -->
                <TabItem Header="테스트 전 이벤트">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <CheckBox Grid.Row="0" Grid.ColumnSpan="2" x:Name="chkPreEventEnabled" Content="테스트 전 이벤트 활성화" Margin="0,0,0,10"/>

                        <TextBlock Grid.Row="1" Text="유형:" VerticalAlignment="Center"/>
                        <ComboBox Grid.Row="1" Grid.Column="1" x:Name="cboPreEventType" Margin="0,0,0,5">
                            <ComboBoxItem Content="명령줄" IsSelected="True"/>
                            <ComboBoxItem Content="PowerShell"/>
                            <ComboBoxItem Content="배치 파일"/>
                            <ComboBoxItem Content="실행 파일"/>
                        </ComboBox>

                        <TextBlock Grid.Row="2" Text="명령/경로:" VerticalAlignment="Center"/>
                        <Grid Grid.Row="2" Grid.Column="1" Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="txtPreEventCommand" Margin="0,0,5,0"/>
                            <Button Grid.Column="1" Content="..." Width="26" Click="BrowsePreEventCommand_Click"/>
                        </Grid>

                        <TextBlock Grid.Row="3" Text="인수:" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="3" Grid.Column="1" x:Name="txtPreEventArgs" Margin="0,0,0,5"/>

                        <TextBlock Grid.Row="4" Text="작업 디렉토리:" VerticalAlignment="Center"/>
                        <Grid Grid.Row="4" Grid.Column="1" Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="txtPreEventWorkDir" Margin="0,0,5,0"/>
                            <Button Grid.Column="1" Content="..." Width="26" Click="BrowsePreEventWorkDir_Click"/>
                        </Grid>

                        <StackPanel Grid.Row="5" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,5,0,0">
                            <TextBlock Text="타임아웃(초):" VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <TextBox x:Name="txtPreEventTimeout" Text="300" Width="60" Margin="0,0,20,0"/>
                            <CheckBox x:Name="chkPreEventStopOnFailure" Content="실패 시 테스트 중단" IsChecked="True" Margin="0,0,10,0"/>
                            <CheckBox x:Name="chkPreEventHideWindow" Content="창 숨김" IsChecked="True"/>
                        </StackPanel>
                    </Grid>
                </TabItem>

                <!-- 테스트 후 이벤트 탭 -->
                <TabItem Header="테스트 후 이벤트">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <CheckBox Grid.Row="0" Grid.ColumnSpan="2" x:Name="chkPostEventEnabled" Content="테스트 후 이벤트 활성화" Margin="0,0,0,10"/>

                        <TextBlock Grid.Row="1" Text="유형:" VerticalAlignment="Center"/>
                        <ComboBox Grid.Row="1" Grid.Column="1" x:Name="cboPostEventType" Margin="0,0,0,5">
                            <ComboBoxItem Content="명령줄" IsSelected="True"/>
                            <ComboBoxItem Content="PowerShell"/>
                            <ComboBoxItem Content="배치 파일"/>
                            <ComboBoxItem Content="실행 파일"/>
                        </ComboBox>

                        <TextBlock Grid.Row="2" Text="명령/경로:" VerticalAlignment="Center"/>
                        <Grid Grid.Row="2" Grid.Column="1" Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="txtPostEventCommand" Margin="0,0,5,0"/>
                            <Button Grid.Column="1" Content="..." Width="26" Click="BrowsePostEventCommand_Click"/>
                        </Grid>

                        <TextBlock Grid.Row="3" Text="인수:" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="3" Grid.Column="1" x:Name="txtPostEventArgs" Margin="0,0,0,5"/>

                        <TextBlock Grid.Row="4" Text="작업 디렉토리:" VerticalAlignment="Center"/>
                        <Grid Grid.Row="4" Grid.Column="1" Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="txtPostEventWorkDir" Margin="0,0,5,0"/>
                            <Button Grid.Column="1" Content="..." Width="26" Click="BrowsePostEventWorkDir_Click"/>
                        </Grid>

                        <TextBlock Grid.Row="5" Text="실행 조건:" VerticalAlignment="Center"/>
                        <ComboBox Grid.Row="5" Grid.Column="1" x:Name="cboPostEventCondition" Margin="0,0,0,5">
                            <ComboBoxItem Content="항상 실행" IsSelected="True"/>
                            <ComboBoxItem Content="테스트 성공 시에만"/>
                            <ComboBoxItem Content="테스트 실패 시에만"/>
                        </ComboBox>

                        <StackPanel Grid.Row="6" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,5,0,0">
                            <TextBlock Text="타임아웃(초):" VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <TextBox x:Name="txtPostEventTimeout" Text="300" Width="60" Margin="0,0,20,0"/>
                            <CheckBox x:Name="chkPostEventHideWindow" Content="창 숨김" IsChecked="True"/>
                        </StackPanel>
                    </Grid>
                </TabItem>
            </TabControl>
        </GroupBox>

        <!-- 스텝 목록과 편집 영역 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- 스텝 목록 -->
            <GroupBox Header="테스트 스텝">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <ListBox x:Name="lstSteps" DisplayMemberPath="Name"
                             SelectionChanged="StepList_SelectionChanged"
                             AllowDrop="True"
                             PreviewMouseLeftButtonDown="StepList_PreviewMouseLeftButtonDown"
                             PreviewMouseMove="StepList_PreviewMouseMove"
                             Drop="StepList_Drop"
                             DragOver="StepList_DragOver"/>

                    <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,5">
                        <Button Content="추가" Click="AddStep_Click" Width="50" Margin="2"/>
                        <Button Content="삭제" Click="RemoveStep_Click" Width="50" Margin="2"/>
                        <Button Content="▲" Click="MoveUp_Click" Width="30" Margin="2"/>
                        <Button Content="▼" Click="MoveDown_Click" Width="30" Margin="2"/>
                    </StackPanel>
                </Grid>
            </GroupBox>

            <!-- 스텝 상세 편집 -->
            <ScrollViewer Grid.Column="1" x:Name="stepEditor" Margin="10,0,0,0">
                <Grid x:Name="gridStepDetail" IsEnabled="False">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 스텝 기본 정보 -->
                    <GroupBox Grid.Row="0" Header="스텝 정보" Margin="0,0,0,10">
                        <Grid Margin="10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Row="0" Text="스텝 이름:" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="0" Grid.Column="1" x:Name="txtStepName" Margin="0,0,0,5"/>

                            <TextBlock Grid.Row="1" Text="대상 VM:" VerticalAlignment="Center"/>
                            <ComboBox Grid.Row="1" Grid.Column="1" x:Name="cboTargetVM" DisplayMemberPath="Name" Margin="0,0,0,5"
                                      SelectionChanged="TargetVM_SelectionChanged"/>

                            <TextBlock Grid.Row="2" Text="스냅샷:" VerticalAlignment="Center"/>
                            <Grid Grid.Row="2" Grid.Column="1" Margin="0,0,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ComboBox x:Name="cboSnapshot" DisplayMemberPath="Name" Margin="0,0,5,0"/>
                                <Button Grid.Column="1" x:Name="btnRefreshSnapshots" Content="↻" Width="26"
                                        Click="RefreshSnapshots_Click" ToolTip="스냅샷 목록 새로고침"/>
                            </Grid>
                        </Grid>
                    </GroupBox>

                    <!-- 파일 복사 (호스트 -> VM) -->
                    <GroupBox Grid.Row="1" Header="파일 복사 (호스트 → VM)" Margin="0,0,0,10">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <DataGrid x:Name="dgFilesToVM" AutoGenerateColumns="False" Height="100" CanUserAddRows="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="소스 경로 (호스트)" Binding="{Binding SourcePath}" Width="*"/>
                                    <DataGridTextColumn Header="대상 경로 (VM)" Binding="{Binding DestinationPath}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,0,0">
                                <Button Content="파일 추가" Click="AddFileToVM_Click" Width="70" Margin="0,0,5,0"/>
                                <Button Content="폴더 추가" Click="AddFolderToVM_Click" Width="70"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>

                    <!-- 실행 설정 -->
                    <GroupBox Grid.Row="2" Header="실행 설정" Margin="0,0,0,10">
                        <Grid Margin="10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Row="0" Text="실행 유형:" VerticalAlignment="Center"/>
                            <ComboBox Grid.Row="0" Grid.Column="1" x:Name="cboExecType" Margin="0,0,0,5">
                                <ComboBoxItem Content="Program" IsSelected="True"/>
                                <ComboBoxItem Content="Script"/>
                                <ComboBoxItem Content="Command"/>
                            </ComboBox>

                            <TextBlock Grid.Row="1" Text="실행 경로:" VerticalAlignment="Center"/>
                            <Grid Grid.Row="1" Grid.Column="1" Margin="0,0,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="txtExecPath" Margin="0,0,5,0"/>
                                <Button Grid.Column="1" Content="..." Width="26" Click="BrowseExecPath_Click" ToolTip="파일 찾아보기"/>
                            </Grid>

                            <TextBlock Grid.Row="2" Text="인수:" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="2" Grid.Column="1" x:Name="txtExecArgs" Margin="0,0,0,5"/>

                            <TextBlock Grid.Row="3" Text="타임아웃(초):" VerticalAlignment="Center"/>
                            <TextBox Grid.Row="3" Grid.Column="1" x:Name="txtTimeout" Text="300" Margin="0,0,0,5"/>
                        </Grid>
                    </GroupBox>

                    <!-- 결과 파일 수집 -->
                    <GroupBox Grid.Row="3" Header="결과 파일 수집 (VM → 호스트)" Margin="0,0,0,10">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <DataGrid x:Name="dgResultFiles" AutoGenerateColumns="False" Height="100" CanUserAddRows="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="소스 경로 (VM)" Binding="{Binding SourcePath}" Width="*"/>
                                    <DataGridTextColumn Header="대상 경로 (호스트)" Binding="{Binding DestinationPath}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                            <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,0,0">
                                <Button Content="대상 폴더 선택" Click="SelectResultFolder_Click" Width="100"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>

                    <!-- 조건부 실행 -->
                    <GroupBox Grid.Row="4" Header="실행 조건" Margin="0,0,0,10">
                        <Grid Margin="10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="100"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Row="0" Text="실행 조건:" VerticalAlignment="Center"/>
                            <ComboBox Grid.Row="0" Grid.Column="1" x:Name="cboConditionType" Margin="0,0,0,5" SelectionChanged="ConditionType_SelectionChanged">
                                <ComboBoxItem Content="항상 실행" IsSelected="True"/>
                                <ComboBoxItem Content="이전 스텝 성공 시"/>
                                <ComboBoxItem Content="이전 스텝 실패 시"/>
                                <ComboBoxItem Content="특정 스텝 결과에 따라"/>
                                <ComboBoxItem Content="모든 이전 스텝 성공 시"/>
                                <ComboBoxItem Content="하나라도 실패 시"/>
                            </ComboBox>

                            <TextBlock Grid.Row="1" Text="참조 스텝:" VerticalAlignment="Center" x:Name="lblRefStep" Visibility="Collapsed"/>
                            <ComboBox Grid.Row="1" Grid.Column="1" x:Name="cboRefStep" DisplayMemberPath="Name" Visibility="Collapsed"/>
                        </Grid>
                    </GroupBox>

                    <!-- 기타 옵션 -->
                    <GroupBox Grid.Row="5" Header="옵션">
                        <StackPanel Margin="10">
                            <CheckBox x:Name="chkForceNetworkDisconnect" Content="네트워크 강제 분리" IsChecked="True" Margin="0,0,0,5"/>
                            <CheckBox x:Name="chkForceSnapshotRevert" Content="완료 후 스냅샷 복원" IsChecked="True" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal">
                                <CheckBox x:Name="chkCaptureScreenshots" Content="스크린샷 캡처" Margin="0,0,10,0"/>
                                <TextBlock Text="간격(초):" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                <TextBox x:Name="txtScreenshotInterval" Text="10" Width="50"/>
                            </StackPanel>
                        </StackPanel>
                    </GroupBox>
                </Grid>
            </ScrollViewer>
        </Grid>

        <!-- 버튼 -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button Content="저장" Click="Save_Click" Width="80" Margin="0,0,10,0" IsDefault="True"/>
            <Button Content="취소" Click="Cancel_Click" Width="80" IsCancel="True"/>
        </StackPanel>
    </Grid>
</Window>
